---
keywords:
  - ESXi网络拓扑实战
  - ESXi虚拟交换机配置
  - ESXi网络实施教程
  - ESXi VLAN配置实战
  - ESXi端口组配置
  - ESXi网络隔离实现
  - ESXi多网段配置
  - ESXi网络管理实战
  - ESXi虚拟化网络部署
  - ESXi网络安全配置
  - 家庭AIO搭建教程
  - 家庭All-in-One搭建教程
description: 基于家庭AIO网络拓扑设计的ESXi网络配置实战教程，详细介绍虚拟交换机创建、端口组配置、VLAN划分等具体实施步骤。
---

前面已经介绍了家庭 AIO 网络拓扑设计，本节开始 ESXi 网络配置实战教程。

## 网段规划回顾

| 网段名称 | IP范围 | 用途 |
|-----------|--------|------|
| 家庭终端网段 | 192.168.8.0/24 | 生产环境虚拟机 |
| 实验室网段 | 10.10.10.0/24 | 开发测试环境 |
| 预留网段 | 10.10.1.0/24 | 扩展预留 |
| ESXi 管理网段 | 192.168.188.0/24 | 基础设施管理 |

## 登入 ESXi 管理后台

按照 [ESXi 基础设置](../preparation/base-settings.md#web) 中通过 Web 浏览器进入 ESXi 管理后台，进入后台后导航到【网络】-【虚拟交换机页面】。

## 配置网段
按照网络规划，我们需配置好：家庭终端网段、实验室网段、预留网段三个网段，我们分别添加这几个网段。
### 家庭终端网段
=== "家庭终端网段虚拟交换机"
    因为是直通网卡，所以不需要 ESXi 中的上行链路，**请将上行链路关闭掉**。
    ![配置家庭终端网段](https://img.it927.com/aio/92.png)

=== "家庭终端网段端口组"

    ![配置家庭终端网段端口组](https://img.it927.com/aio/93.png)

### 实验室网段
=== "实验室网段虚拟交换机"
    因为是软路由进行流量中转，所以也不需要 ESXi 中的上行链路，**请将上行链路关闭掉**。
    ![配置实验室网段虚拟交换机](https://img.it927.com/aio/94.png)

=== "实验室网段端口组"

    ![配置实验室网段端口组](https://img.it927.com/aio/95.png)

### 预留网段
=== "预留网段虚拟交换机"
    因为是软路由进行流量中转，所以也不需要 ESXi 中的上行链路，**请将上行链路关闭掉**。
    ![预留网段虚拟交换机](https://img.it927.com/aio/96.png)

=== "预留网段端口组"

    ![预留网段端口组](https://img.it927.com/aio/97.png)

配置好后，得到虚拟交换机和端口组如下：
=== "虚拟交换机"
    ![虚拟交换机](https://img.it927.com/aio/98.png)

=== "端口组"
    ![端口组](https://img.it927.com/aio/99.png)

## 主路由设置（家庭终端网段）

网段已经设置好了，接下来是安装软路由，因为我们要将两个板载的 2.5G 螃蟹网卡直通给软路由，所以先要进行直通。

### 直通板载网卡

限于篇幅的原因，这部分后面的文章有详细讲解，按照 [ESXi 进阶操作 - 硬件直通](../esxi/passthrough.md#_3)
章节直通即可，需注意的是：不要直通错了网卡。

### 安装软路由

限于篇幅的原因，这部分在后面 [软路由 - 系统安装](../route/install.md) 章节中有详细介绍，陈大剩我不在赘述，大家自己看后面的章节即可，需要注意的是
**直通网卡** 和 **WAN/LAN** 设置，不要忘了 **虚拟端口组** 选择的 **家庭终端网段端口组1**。

### 网络配置

网络配置阶段需要看是：24 小时开机、随时开机方案，24 小时开机由软路由进行拨号，随时开机方案则是中继上级路由器网段。

#### 24 小时开机网络配置

24 小时开机主路由网络架构如下：
![24 小时开机主路由网络架](https://img.it927.com/aio/140.png)

首先，将光猫改为桥接，以我的中兴光猫 F7005Tv3 2.5G 为例，先用一根网线连接光猫，陈大剩这里插的是光猫千兆网口。
=== "访问光猫管理后台"
    浏览器输入`192.168.1.1` 访问，账号为：telecomadmin，超级密码为：nE7jA%5m
    ![访问光猫管理后台](https://img.it927.com/aio/177.png)

=== "修改网络连接信息"
    导航到：【网络】-【网络设置】-【网络连接】选择 `2_INTERNET_B_VID_2001` 连接，进行如下设置，连接模式改为：桥接，LAN 口绑定按需选择。
    ![修改网络连接信息](https://img.it927.com/aio/178.png)

桥接改完后，再将光猫的 LAN 直接接入主路由的 WAN 口， 在软路由中新建一个 PPPoE 接口。
=== "WAN 接口设置"
    导航【网络】-【接口】编辑 wan 接口，如果没有需新建一个 `wan` 接口，协议选择 PPPoE，设备陈大剩这里是选择 `eth2`
    ![新建 wan 接口](https://img.it927.com/aio/172.png)

=== "常规设置"
    常规设置中，【PAP/CHAP 用户名】为宽带账户名，【PAP/CHAP 密码】为宽带密码。
    ![常规设置](https://img.it927.com/aio/173.png)

点击【保存并应用】后，等待一会（3-5 分钟）会出现如下页面，证明拨号成功，还会新出一个 wan_6 接口，这里先不用管。
    ![PPPoE拨号网络拓扑](https://img.it927.com/aio/149.png)
    lan 口需要配置一个网段，和 DHCP 服务，导航【网络】-【接口】-【lan】
=== "LAN 接口设置"
    IPv4 地址填填写家庭网段终端地址 `192.168.8.1`，IPv4 默认网关不填，然后点击保存。
    ![LAN 接口设置](https://img.it927.com/aio/174.png)

=== "LAN 接口设置 DHCP"
    【DHCP 服务器】-【常规设置】中【忽略此接口】不勾选，启动默认 100 或 1 都行，客户数也就是终端数，一般家庭终端不会超过 100，超过 100
    的话，启动建议填写为 1。
    ![LAN 接口设置](https://img.it927.com/aio/175.png)

点击【保存并应用】后，系统会提示连接更改，也就是说：保存后，需要再 90 秒内，手动访问新的 `192.168.8.1`，否则，系统将恢复到之前的配置状态。
![保存并应用](https://img.it927.com/aio/144.png)
立即访问 `http://192.168.8.1`，看到"配置已应用"提示即表示配置成功：
![点击后需要立马访问](https://img.it927.com/aio/176.png)
至此，24 小时开机网络配置完毕。

#### 随时开机方案网络配置

随时开机方案网络架构如下：
![随时开机网络架构](https://img.it927.com/aio/139.png)

???+ info "提示"
    因随时开机方案中继的特性，主路由相当于一个傻瓜交换机，主路由做不了任何功能，如去广告、代理等。如随时开机方案需要其他功能，建议下一个网段（实验室网段、预留网段）上使用，当然也可使用旁路由技术，旁路由技术有些玄学，且必须要
    AIO 开机才能走，不如直接选 24 小时开机方案。如果选择随时开机方案，建议 **上级路由器使用一个带软路由路由器**。

首先，将路由器的 LAN 直接接入主路由的 WAN 口，然后开始设置中继流程，设置中继流程比较简单，只需要把 WAN 变成 LAN
口就是行，此时主路由相当于一个傻瓜交换机。
=== "LAN 设置静态 IP"
    导航【网络】-【接口】，将 lan 口协议改为和上一级路由器同一个网段的静态 IP ，按照规划，上一级属于 `192.168.8.x` 网段，这里设置为
    `192.168.8.10`，并设置网关。
    ![lan 设置静态 IP](https://img.it927.com/aio/145.png)  
    ???+ warning "IP 地址冲突检查"    
        设置为 `192.168.8.10` 需查看和上级路由中有没有设备已经占用 `192.168.8.10`，否则会设置不成功。

=== "LAN 关闭 DHCP"
    导航【网络】-【接口】-【lan】-【DHCP 服务器】-【常规设置】勾选【忽略此接口】。
    ![lan 关闭 dhcp](https://img.it927.com/aio/166.png)

=== "删除 WAN 口"
    导航【网络】-【接口】，将 WAN 和 WAN6 删除
    ![删除 WAN 口](https://img.it927.com/aio/141.png)

=== "所有网口桥接"
    导航【网络】-【设备】-【br-lan】，将所有网口设为桥接
    ![所有网口桥接](https://img.it927.com/aio/142.png)

点击【保存并应用】后，系统会提示连接更改，也就是说：保存后，需要再 90 秒内，手动访问新的 `192.168.8.10`，否则，系统将恢复到之前的配置状态。
![保存并应用](https://img.it927.com/aio/144.png)
立即访问 `http://192.168.8.10`，看到"配置已应用"提示即表示配置成功：
![点击后需要立马访问](https://img.it927.com/aio/146.png)
至此，随时开机方案网络架构配置完毕。

### 开启 IPv6

根据网络拓扑设置，家庭终端网络中的设备还需要开启
IPv6，限于篇幅的原因，这部分后面的文章有详细讲解 [软路由 - 开启 IPv6](../route/ipv6.md)，需注意的是如果是 24
小时开机网络配置，应按照 [软路由 - 开启 IPv6 - 场景一](../route/ipv6.md#pppoe-ipv624)
方案配置；随时开机方案，按照 [软路由 - 开启 IPv6 - 场景三](../route/ipv6.md#ipv624) 配置。

## 实验室网段设置

实验室网段是 [主路由设置（家庭终端网段）](#_3) 下级网段，实验室网段 WAN 为家庭终端网段的 LAN
口，需借助 [主路由设置（家庭终端网段）](#_3) 进行上网，此网段无需任何直通，仅使用虚拟交换机。

### 安装软路由

限于篇幅的原因，这部分在后面 软路由 - 系统安装 章节中有详细介绍，陈大剩我不在赘述，大家自己看后面的章节即可。
![安装软路由](https://img.it927.com/aio/179.png)
实验室网段硬件设置建议 CPU 为 2 核心，内存为 2GB，不要忘了需要两个网络适配器， **家庭终端网段端口组1**、**实验室网段端口组1
**，因 **此网段没有直通网卡，所以不能通过 WEB 页面访问**，配置好点打开电源后，通过 ESXi 管理页面访问即可。

### 网络配置

我们通过 ESXi 管理页面进入此路由，可使用 `ip add show` 查看网卡：
![网络配置](https://img.it927.com/aio/180.png)
如果像陈大剩一样，显示的 `eth0` 和 `eth1` 网卡均未有 IP 地址，又由于我们 **主路由（家庭终端网段）**
已经打开，所以按理来说陈大剩这里应该有一个网卡有地址的，然后我们又看到 `eth0` 桥接到 br-lan 接口上。

所以根据这几个原因，可判断 `eth0` 是 **主路由（家庭终端网段）** 接口，由于被桥接了所以未能正确识别到，现在可以确定好 `eth0` 为
WAN 口， `eth1` 为 LAN 口。
???+ info "提示"
    如果还是不清楚，可导航【网络】-【端口组】点击【家庭终端网段端口组1】查看网卡的 `mac` 地址，陈大剩这里为：`00:0c:29:f7:1f:a5`
    ，当这里是个虚拟的网卡 `mac` 地址。
    ![mac地址查看](https://img.it927.com/aio/181.png)

接下来进行配置：

```bash
# 编辑当前网络配置
vim /etc/config/network
```

在下面添加三行 `wan` 接口，并修改 LAN 口的网段地址为 `10.10.10.1`

```bash
config interface 'lan'
	option device 'br-lan'
	option proto 'static'
	option ipaddr '10.10.10.1' #修改网段地址
	option netmask '255.255.255.0'
	option ip6assign '60'

# 新添加的三行
config interface 'wan'
	option ifname 'eth0'
	option proto 'dhcp'
```
???+ warning  "警告"

    如果已经存在可 `wan` 接口，则修改即可，无需再添加。    

再重启网卡即可
```bash
# 重启网络服务
/etc/init.d/network restart
```
![网络详情](https://img.it927.com/aio/184.png)
可以看到已经有了 IP 地址 `192.168.8.240`，可以 ping 一下百度是否有网。

### 防火墙设置
因实验室网段是家庭终端网段的下级路由，也就是说实验室网段 WAN 口还会保留一个家庭终端网段的地址，我们只需要将 WAN 口的入站规则打开，即可通过家庭终端网段访问实验室网段软路由的管理页面了。

编辑防火墙
```bash
# 编辑防火墙
vim /etc/config/firewall 
```
将 `wan` 口的入站规则（input）改为接受
```bash
config zone                           
        option name             wan   
        list   network          'wan' 
        list   network          'wan6'
        option input            ACCEPT #改为接受
        option output           ACCEPT
        option forward          REJECT
        option masq             1     
        option mtu_fix          1     
```
再重启防火墙
```bash
# 重启防火墙
/etc/init.d/firewall restart
```
可以通过其他家庭终端网段的设备，访问 `192.168.8.240`，其他设置可以自行设置。
![访问管理页面](https://img.it927.com/aio/185.png)

至此，实验室网段就安装完了。

## 预留网段设置

预留网段也是 [主路由设置（家庭终端网段）](#_3) 下级网段，实验室网段 WAN 为家庭终端网段的 LAN
口，需借助 [主路由设置（家庭终端网段）](#_3) 进行上网，此网段无需任何直通，仅使用虚拟交换机。

### 安装软路由

限于篇幅的原因，这部分在后面 [软路由 - 系统安装](../route/install.md)  章节中有详细介绍，陈大剩我不在赘述，大家自己看后面的章节即可。
![安装软路由](https://img.it927.com/aio/179.png)
实验室网段硬件设置建议 CPU 为 2 核心，内存为 2GB，不要忘了需要两个网络适配器， **家庭终端网段端口组1**、**预留网段端口组1**
，因 **此网段没有直通网卡，所以不能通过 WEB 页面访问**，配置好点打开电源后，通过 ESXi 管理页面访问即可。

### 网络配置

网络配置和 [实验室网段设置 - 实验室网段设置](#_10) 不能说一模一样，只是说有细小差别，只需在 LAN 口出更改一下网断为
`10.10.1.1` 即可：
接下来进行配置：

```bash
# 编辑当前网络配置
vim /etc/config/network
```

在下面添加三行 `wan` 接口，并修改 LAN 口的网段地址为 `10.10.1.1`

```bash
config interface 'lan'
	option device 'br-lan'
	option proto 'static'
	option ipaddr '10.10.10.1' #修改网段地址
	option netmask '255.255.255.0'
	option ip6assign '60'

# 新添加的三行
config interface 'wan'
	option ifname 'eth0'
	option proto 'dhcp'
```
???+ warning  "警告"

    如果已经存在可 `wan` 接口，则修改即可，无需再添加。    

再重启网卡即可
```bash
# 重启网络服务
/etc/init.d/network restart
```
![网络详情](https://img.it927.com/aio/186.png)
可以看到已经有了 IP 地址 `192.168.8.189`，可以 ping 一下百度是否有网。
### 防火墙设置
参考 [实验室网段设置 - 防火墙设置](#_14) 即可。


至此，预留网段设置就安装完了。

## 总结
三个网段也就配置完了，可以看到，我们已经有了三台虚拟机了，分别为一个主路由，两个副路由。
![虚拟机](https://img.it927.com/aio/183.png)

最后，是将三台虚拟机配置成 **开机启动**，限于篇幅的原因，这部分在后面 [ESXi 进阶操作 - 虚拟机自启动
](../esxi/self-starting.md) 章节中有详细介绍，陈大剩我不在赘述，大家自己看后面的章节即可。